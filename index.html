<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	<script src="onscan.js"></script>
	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-light bg-light">
  <span class="navbar-brand mb-0 h1">onScan.js Playground</span>
</nav>
<div class="container">
	<div class="row">
		<div class="col-12">
			<h3>Options</h3> 
		</div>
	</div>
	<form>
		<div class="row">
			<div class="col-12">
				<table style="witdh:100%">
					<tr>
						<td><label>timeBeforeScanTest: </label></td>
						<td><input id="iTimeBeforeScanTest" class="form-control" value=100></input></td>
						<td></td>
					<tr>
						<td><label>avgTimeByChar: </label></td>
						<td><input id="iAvgTimeByChar" class="form-control" value=30></input></td>
						<td></td>
					<tr>
						<td><label>minLength: </label></td>
						<td><input id="iMinLength" class="form-control" value=6></input></td>
						<td></td>
					<tr>
						<td><label>suffixKeyCodes: </label></td>
						<td><input id="iEndChar" class="form-control" value=9,13></input></td>
						<td></td>
					<tr>
						<td><label>prefixKeyCodes: </label></td>
						<td><input id="iStartChar" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>ignoreIfFocusOn: </label></td>
						<td><input type="checkbox" id="iIgnoreIfFocusOn" class="form-control"></input></td>
						<td><input id="focusExample" class="form-control" placeholder="focus here"></input></td>
					<tr>
						<td><label>scanButtonKeyCode: </label></td>
						<td><input id="iScanButtonKeyCode" class="form-control" ></input></td>
						<td></td>	
					<tr>
						<td><label>scanButtonLongPressTime: </label></td>
						<td><input id="iScanButtonLongPressThreshold" class="form-control" value=500></input></td>
						<td></td>
					<tr>
						<td><label>onScanButtonLongPress: </label></td>
						<td><input type="checkbox" id="iOnScanButtonLongPressed" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>singleScanQty </label></td>
						<td><input id="iSingleScanQty" class="form-control" value=1></input></td>
						<td></td>
					<tr>
						<td><label>stopPropagation: </label></td>
						<td><input type="checkbox" id="iStopPropagation" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>preventDefault: </label></td>
						<td><input type="checkbox" id="iPreventDefault" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>onScan: </label></td>
						<td><input type="checkbox" id="iOnComplete" class="form-control" checked="checked"></input></td>
						<td></td>
					<tr>
						<td><label>onScanError: </label></td>
						<td><input type="checkbox" id="iOnError" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>onKeyProcess: </label></td>
						<td><input type="checkbox" id="iOnKeyProcessed" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>onKeyDetect: </label></td>
						<td><input type="checkbox" id="iOnKeyDetect" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>reactToPaste: </label></td>
						<td><input type="checkbox" id="iAcceptPasteInput" class="form-control" ></input></td>
						<td></td>
					<tr>
						<td><label>scan Eventhandler: </label></td>
						<td><input type="checkbox" id="iCompleteHandler" class="form-control"></input></td>
						<td></td>
					<tr>
						<td><label>scanError Eventhandler: </label></td>
						<td><input type="checkbox" id="iErrorHandler" class="form-control" ></input></td>
						<td></td>
					<tr>
						<td><label>keyCodeMapper: </label></td>
						<td><input type="checkbox" id="ikeyCodeMapper" class="form-control" ></input></td>
						<td></td>
					<tr>
						<td>
					
				</table>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<input style="margin: 5px 5px 0 5px" type="button" id="bGenerateonScan" class="btn btn-primary" onclick="generateonScan()" value="attachTo(document)"></input>
				<input style="margin: 5px 5px 0 5px" type="button" id="bDestroyonScan" class="btn btn-primary" onclick="destroyonScan()" value="detachFrom(document)"></input>
				<input style="margin: 5px 5px 0 5px" type="button" id="bGgetonScanSettings" class="btn btn-primary" onclick="getonScanSettings()" value="getOptions()"></input>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<div style="margin: 5px 5px 0 5px" class="input-group mb-3">
  					<input id="iTestInput" class="form-control" placeholder="enter scan code"></input>
					<div class="input-group-append">
				    	<span class="input-group-text btn btn-primary" id="bFireTestInput" onclick="fireTestInput()" >simulate()</span>
				  	</div>
				</div>
			</div>
		</div>
		
	</form>
	<div class="row">
		<div class="col-12">
			<h3>Output</h3> 
		</div>
	</div>
	<div class="row">
		<div class="col-12">
			<textarea style="margin: 5px 5px 0 5px" id="consoleTextField" readonly="readonly" class="form-control" rows="10"></textarea>
		</div>
	</div>
	<div class="row">
		<div class="col-12">
			<input style="margin: 5px 5px 0 5px" type="button" id="clearTextArea" class="btn btn-primary" onclick="clearTextArea()" value="Clear Console Log"></input>
		</div>
	</div>
</div>
<script>

	if (typeof console  != "undefined") 
    if (typeof console.log != 'undefined')
        console.olog = console.log;
    else
        console.olog = function() {};

	console.log = function(message, error) {
		console.olog(message);
		if (error){ 
			document.getElementById('consoleTextField').value += "ERROR: " + message + '\n';
		} else {
			document.getElementById('consoleTextField').value += ('> ' + message + '\n');
		}
		document.getElementById('consoleTextField').scrollTop = document.getElementById('consoleTextField').scrollHeight;
	};
	console.error = console.debug = console.info =  console.log;

	window.onerror = function(msg){
			console.log(msg, true);
	}


	document.getElementById("focusExample").style.visibility="hidden";
	
	function generateonScan(){
		
		
		var prop;
		var array;
		var suffixKeyCodes = [];
		var prefixKeyCodes = [];
		
		
		if (document.getElementById("iEndChar").value){
			array = document.getElementById("iEndChar").value.split(",");
			for (prop in array)
				suffixKeyCodes.push(parseInt(array[prop]));
	//			suffixKeyCodes.push(parseInt(prop));
		}
		if (document.getElementById("iStartChar").value){
			array = document.getElementById("iStartChar").value.split(",")
			for (prop in document.getElementById("iStartChar").value.split(","))
				prefixKeyCodes.push(parseInt(array[prop]));
		}
						
		var options = {
			timeBeforeScanTest: parseInt(document.getElementById("iTimeBeforeScanTest").value), 
			avgTimeByChar: parseInt(document.getElementById("iAvgTimeByChar").value),
			minLength: parseInt(document.getElementById("iMinLength").value), 
			suffixKeyCodes: suffixKeyCodes,
			prefixKeyCodes: prefixKeyCodes, 
			scanButtonLongPressTime: parseInt(document.getElementById("iScanButtonLongPressThreshold").value), 
			stopPropagation: document.getElementById("iStopPropagation").checked, 
			preventDefault: document.getElementById("iPreventDefault").checked,
			reactToPaste: document.getElementById("iAcceptPasteInput").checked,
			singleScanQty: parseInt(document.getElementById("iSingleScanQty").value)
		}
		
		if (document.getElementById("iOnComplete").checked){
			options.onScan = function(barcode, qty){
				console.log("[onScan]: Code: " + barcode + " Quantity: " + qty);
			};
		} else {
			options.onScan = function(){};
		}
				
		if (document.getElementById("iOnError").checked){
			options.onScanError = function(err){
				var sFormatedErrorString = "Error Details: \n";
				var aJSONArray = JSON.stringify(err).split(",");
				for (prop = 0; prop < aJSONArray.length - 1; prop++){
					sFormatedErrorString += aJSONArray[prop] + "," + "\n";
				}
				sFormatedErrorString += aJSONArray[aJSONArray.length - 1];
				
				console.log("[onScanError]: " + sFormatedErrorString);
			}; 	
		} else {
			options.onScanError = function(){};
		}
		
		
		if (document.getElementById("iOnKeyProcessed").checked){
			options.onKeyProcess = function(iKey, oEvent){
				console.log("[onKeyProcess]: Processed key code: " + iKey);
			};
		} else {
			options.onKeyProcess = function(){};
		}
		
		
		if (document.getElementById("iOnKeyDetect").checked){
			options.onKeyDetect = function(iKey, oEvent){
				console.log("[onKeyDetect]: Detected key code: " + iKey);
			};
		} else {
			options.onKeyDetect = function(){};
		}
		
		if (document.getElementById("iIgnoreIfFocusOn").checked){
			options.ignoreIfFocusOn = "focusExample";
			document.getElementById("focusExample").style.visibility = "visible";
		} else {
			document.getElementById("focusExample").style.visibility="hidden";	
		}
		
		if (document.getElementById("iScanButtonKeyCode").value){
			options.scanButtonKeyCode = parseInt(document.getElementById("iScanButtonKeyCode").value);
		} else {
			options.scanButtonKeyCode = false;
		}
		
		if (document.getElementById("iOnScanButtonLongPressed").checked){
			options.onScanButtonLongPress = function(){
				console.log("[onScanButtonLongPress]: ScanButton has been long-pressed");
			};
		} else {
			options.onScanButtonLongPress = function(){};
		}
		
		if (options.reactToPaste){
			options.onPaste = function(sPasteString){
				console.log("[onPaste]: Data has been pasted: " + sPasteString);
			}
		} else {
			options.onPaste = function(){};
		}
							
		if (document.getElementById("iCompleteHandler").checked){
			document.addEventListener('scan', scanHandler);
		} else {
			document.removeEventListener('scan', scanHandler);
		}
		
		if (document.getElementById("iErrorHandler").checked){
			document.addEventListener('scanError', scanErrorHandler);
		} else {
			document.removeEventListener('scanError', scanErrorHandler);
		}
		
		if (document.getElementById("ikeyCodeMapper").checked){
			options.keyCodeMapper = function (e) {
				var iKeyCode = e.which;
				var sChar = String.fromCharCode(iKeyCode);
				console.log('[keyCodeMapper]: Decoding key code "' + iKeyCode + '" to "' + sChar + '"')
			}
		} else {
			options.keyCodeMapper = function(oEvent){
				return String.fromCharCode(oEvent.which);
			}
		}

		
		
		try {
			if (onScan.attachTo(document, options) === undefined) console.log("onScan Started!");
		} catch(e) {
			if (onScan.setOptions(document, options) === undefined) console.log("onScansettings changed!");
		}
		

	}
	
	function destroyonScan(){
		console.log("onScan destroyed!");
		onScan.detachFrom(document);	
	}

	
	function clearTextArea(){
		document.getElementById('consoleTextField').value = "";
	}
	
	function scanHandler(e){
		console.log("[scanHandler]: Code: " + e.detail.code);
	}
	
	function scanErrorHandler(e){
		console.log("[scanErrorHandler]: Invalid Scan. Receieved Code: " + e.detail.code );
		console.log("[scanErrorHandler]: Errormessage: " + e.detail.message);
	}
	
	function getonScanSettings(){
		var sFormatedErrorString = "Scanner Settings: \n";
				var aJSONArray = JSON.stringify(onScan.getOptions(document)).split(",");
				for (prop = 0; prop < aJSONArray.length - 1; prop++){
					if (aJSONArray[prop+1][0] == '\"'){
						sFormatedErrorString += aJSONArray[prop] + "," + "\n";
					} else {
						sFormatedErrorString += aJSONArray[prop] + ",";
					}
				}
				sFormatedErrorString += aJSONArray[aJSONArray.length - 1];
				
				console.log(sFormatedErrorString);
		
		
	}
	
	function fireTestInput(){
		onScan.simulate(document, document.getElementById("iTestInput").value);
	}
	
	(function(){
		generateonScan();
	})();
</script>


</body>
</html>